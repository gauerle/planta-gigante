<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Troca de Plant√µes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            background: white;
        }
        
        tr:hover td {
            background: #f8f9fa;
        }
        
        .feriado td {
            background: #fff3cd !important;
        }
        
        .feriado:hover td {
            background: #ffe8a1 !important;
        }
        
        .nao-trocar td {
            background: #f8d7da !important;
        }
        
        .nao-trocar:hover td {
            background: #f5c6cb !important;
        }
        
        .checkbox-cell {
            text-align: center;
        }
        
        .checkbox-cell input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }
        
        select, input, textarea {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .dates-selection {
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }
        
        .date-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .date-checkbox:hover {
            background: #f8f9fa;
        }
        
        .date-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-aprovada {
            background: #d4edda;
            color: #155724;
        }
        
        .status-recusada {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .instructions ul {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
            color: #495057;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }
        
        .login-box h2 {
            text-align: center;
            color: #212529;
            margin-bottom: 30px;
        }
        
        .login-box .form-group {
            margin-bottom: 20px;
        }
        
        .login-box .btn-primary {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
        }
        
        #app {
            display: none;
        }
        
        #loginScreen {
            display: block;
        }

        .date-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #212529;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .troca-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-box">
                <h2>üè• Sistema de Plant√µes</h2>
                <div class="form-group">
                    <label>Selecione seu nome:</label>
                    <select id="loginSelect">
                        <option value="">Escolha seu nome...</option>
                        <option value="Ana Laura de Oliveira Carvalho">Ana Laura de Oliveira Carvalho</option>
                        <option value="B√°rbara Geovanna Farias Dami√£o">B√°rbara Geovanna Farias Dami√£o</option>
                        <option value="Daniella Martins de Oliveira">Daniella Martins de Oliveira</option>
                        <option value="Isabella Colombani">Isabella Colombani</option>
                        <option value="Jo√£o V√≠tor Almeida das Virgens">Jo√£o V√≠tor Almeida das Virgens</option>
                        <option value="Jose Paulo Sonda Sampaio">Jose Paulo Sonda Sampaio</option>
                        <option value="Liane Venesia Da Silva">Liane Venesia Da Silva</option>
                        <option value="Lucas Catarino Garcia">Lucas Catarino Garcia</option>
                        <option value="Lu√≠s Eduardo Gauer">Lu√≠s Eduardo Gauer</option>
                        <option value="Marcos Ant√¥nio Faria">Marcos Ant√¥nio Faria</option>
                        <option value="Marilia Escrivani de Almeida Petrillo">Marilia Escrivani de Almeida Petrillo</option>
                        <option value="Pedro Henrique de Moraes Moreira">Pedro Henrique de Moraes Moreira</option>
                        <option value="Rian Henrico Alves Ferreira">Rian Henrico Alves Ferreira</option>
                        <option value="Thaisa Ramos Freire">Thaisa Ramos Freire</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="login()">Entrar</button>
            </div>
        </div>
    </div>

    <div id="app">
        <div class="container">
            <div class="header">
                <h1>üè• Sistema de Troca de Plant√µes</h1>
                <div class="user-info">
                    <span class="user-name">üë§ <span id="currentUserName"></span></span>
                    <button class="btn-logout" onclick="logout()">Sair</button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('escala')">üìÖ Escala Original</button>
                <button class="tab" onclick="showTab('escalaAtualizada')">üìã Escala Atualizada</button>
                <button class="tab" onclick="showTab('solicitacoes')">üîÑ Solicita√ß√µes</button>
                <button class="tab" onclick="showTab('historico')">üìä Hist√≥rico</button>
            </div>
            
            <div id="escala" class="tab-content active">
                <div class="instructions">
                    <h3>üìã Como usar a escala</h3>
                    <ul>
                        <li>Consulte sua escala aqui</li>
                        <li>Use os filtros para encontrar datas ou pessoas espec√≠ficas</li>
                        <li>Datas em <strong style="background: #fff3cd; padding: 2px 6px;">amarelo</strong> s√£o feriados</li>
                        <li>Marque as datas que voc√™ N√ÉO quer trocar (ficar√£o em <strong style="background: #f8d7da; padding: 2px 6px;">vermelho</strong>)</li>
                    </ul>
                </div>

                <div class="filter-section">
                    <div class="filter-group form-group">
                        <label>Filtrar por Nome:</label>
                        <select id="filterName" onchange="filterEscala()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group form-group">
                        <label>Filtrar por Data:</label>
                        <input type="text" id="filterDate" placeholder="Ex: 23/out" oninput="filterEscala()">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="clearFilters()">Limpar Filtros</button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="escalaTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Dia</th>
                                <th>Plant√£o Curto</th>
                                <th>N√£o Trocar (Curto)</th>
                                <th>Plant√£o Longo</th>
                                <th>N√£o Trocar (Longo)</th>
                                <th>Feriado</th>
                            </tr>
                        </thead>
                        <tbody id="escalaBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="escalaAtualizada" class="tab-content">
                <div class="instructions">
                    <h3>üìã Escala Atualizada com Trocas</h3>
                    <ul>
                        <li>Esta √© a escala REAL considerando as trocas aprovadas</li>
                        <li>Nomes com <span class="troca-badge">TROCADO</span> indicam que houve troca</li>
                        <li>Use os filtros para encontrar suas datas atualizadas</li>
                    </ul>
                </div>

                <div class="filter-section">
                    <div class="filter-group form-group">
                        <label>Filtrar por Nome:</label>
                        <select id="filterNameAtualizada" onchange="filterEscalaAtualizada()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group form-group">
                        <label>Filtrar por Data:</label>
                        <input type="text" id="filterDateAtualizada" placeholder="Ex: 23/out" oninput="filterEscalaAtualizada()">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="clearFiltersAtualizada()">Limpar Filtros</button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="escalaAtualizadaTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Dia</th>
                                <th>Plant√£o Curto</th>
                                <th>Plant√£o Longo</th>
                                <th>Feriado</th>
                            </tr>
                        </thead>
                        <tbody id="escalaAtualizadaBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="solicitacoes" class="tab-content">
                <div class="instructions">
                    <h3>üîÑ Como solicitar uma troca</h3>
                    <ul>
                        <li>Selecione o plant√£o que voc√™ DESEJA (data e tipo)</li>
                        <li>Selecione TODAS as suas datas (do mesmo tipo) que voc√™ est√° disposto a oferecer em troca</li>
                        <li>O destinat√°rio poder√° escolher qual das suas datas ele prefere</li>
                    </ul>
                </div>
                
                <div class="form-section">
                    <div class="form-title">Nova Solicita√ß√£o de Troca</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Plant√£o DESEJADO - Data *</label>
                            <select id="dataDesejada" onchange="updateTipoDesejadoOptions()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plant√£o DESEJADO - Tipo *</label>
                            <select id="tipoDesejado" onchange="filterAvailableDates()">
                                <option value="">Selecione...</option>
                                <option value="Curto">Plant√£o Curto</option>
                                <option value="Longo">Plant√£o Longo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Suas Datas Dispon√≠veis para Oferecer (mesmo tipo do plant√£o desejado) *</label>
                        <div class="dates-selection" id="datasDisponiveis"></div>
                    </div>
                    <div class="form-group">
                        <label>Observa√ß√µes (opcional)</label>
                        <textarea id="observacoes" placeholder="Ex: Motivo da troca, disponibilidade para conversar, etc."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="enviarSolicitacao()">Enviar Solicita√ß√£o</button>
                </div>
                
                <div id="alertContainer"></div>
                
                <div class="form-title" style="margin-top: 40px;">Solicita√ß√µes Recebidas (para voc√™ aprovar/recusar)</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Solicitante</th>
                                <th>Quer Trocar</th>
                                <th>Datas Oferecidas</th>
                                <th>Status</th>
                                <th>Observa√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="solicitacoesRecebidasBody"></tbody>
                    </table>
                </div>

                <div class="form-title" style="margin-top: 40px;">Minhas Solicita√ß√µes Enviadas</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Destinat√°rio</th>
                                <th>Plant√£o Desejado</th>
                                <th>Minhas Datas Oferecidas</th>
                                <th>Status</th>
                                <th>Data Escolhida</th>
                                <th>Observa√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="solicitacoesEnviadasBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="historico" class="tab-content">
                <div class="instructions">
                    <h3>üìä Hist√≥rico de Trocas</h3>
                    <ul>
                        <li>Visualize todas as trocas realizadas</li>
                        <li>Se voc√™ for o dono original da vaga, pode revogar a troca</li>
                    </ul>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Pessoa 1</th>
                                <th>Plant√£o Pessoa 1</th>
                                <th>Pessoa 2</th>
                                <th>Plant√£o Pessoa 2</th>
                                <th>Data Aprova√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="historicoBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para selecionar data espec√≠fica -->
    <div id="dateSelectModal" class="date-selector-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Selecione a data que voc√™ prefere</h3>
                <button class="close-modal" onclick="closeDateModal()">√ó</button>
            </div>
            <div id="modalDatesContainer"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="confirmDateSelection()">Confirmar</button>
                <button class="btn btn-danger" onclick="closeDateModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, onSnapshot, orderBy, serverTimestamp, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ‚ö†Ô∏è Estas credenciais s√£o p√∫blicas mas est√£o restritas por dom√≠nio no Google Cloud Console
        const firebaseConfig = {
            apiKey: "AIzaSyB2VLDwcdyYZBh1G2qsmmOUoCzZfbbjOWw",
            authDomain: "planta-gigante.firebaseapp.com",
            projectId: "planta-gigante",
            storageBucket: "planta-gigante.firebasestorage.app",
            messagingSenderId: "424711085023",
            appId: "1:424711085023:web:e7c1e68c28a5dfac856c18"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Datas de feriados
        const feriados = ['27/out.', '28/out.', '20/nov.', '21/nov.', '08/dez.', '25/dez.', '01/jan.', '02/jan.'];

        // Dados da escala completa
        const escalaDataOriginal = [
            ["23/out.", "Quinta", "Rian Henrico Alves Ferreira", "Thaisa Ramos Freire"],
            ["24/out.", "Sexta", "B√°rbara Geovanna Farias Dami√£o", "Daniella Martins de Oliveira"],
            ["25/out.", "S√°bado", "Marilia Escrivani de Almeida Petrillo", "Lu√≠s Eduardo Gauer"],
            ["26/out.", "Domingo", "Liane Venesia Da Silva", "Marcos Ant√¥nio Faria"],
            ["27/out.", "Segunda", "Lucas Catarino Garcia", "Jo√£o V√≠tor Almeida das Virgens"],
            ["28/out.", "Ter√ßa", "Marilia Escrivani de Almeida Petrillo", "Isabella Colombani"],
            ["29/out.", "Quarta", "Lu√≠s Eduardo Gauer", "Daniella Martins de Oliveira"],
            ["30/out.", "Quinta", "Pedro Henrique de Moraes Moreira", "Rian Henrico Alves Ferreira"],
            ["31/out.", "Sexta", "Jose Paulo Sonda Sampaio", "Thaisa Ramos Freire"],
            ["01/nov.", "S√°bado", "Ana Laura de Oliveira Carvalho", "Lu√≠s Eduardo Gauer"],
            ["02/nov.", "Domingo", "B√°rbara Geovanna Farias Dami√£o", "Daniella Martins de Oliveira"],
            ["03/nov.", "Segunda", "Ana Laura de Oliveira Carvalho", "Marcos Ant√¥nio Faria"],
            ["04/nov.", "Ter√ßa", "Marilia Escrivani de Almeida Petrillo", "Jo√£o V√≠tor Almeida das Virgens"],
            ["05/nov.", "Quarta", "Lu√≠s Eduardo Gauer", "Isabella Colombani"],
            ["06/nov.", "Quinta", "Jose Paulo Sonda Sampaio", "Liane Venesia Da Silva"],
            ["07/nov.", "Sexta", "Ana Laura de Oliveira Carvalho", "Rian Henrico Alves Ferreira"],
            ["08/nov.", "S√°bado", "Lucas Catarino Garcia", "Marilia Escrivani de Almeida Petrillo"],
            ["09/nov.", "Domingo", "B√°rbara Geovanna Farias Dami√£o", "Thaisa Ramos Freire"],
            ["10/nov.", "Segunda", "Lucas Catarino Garcia", "Liane Venesia Da Silva"],
            ["11/nov.", "Ter√ßa", "Marilia Escrivani de Almeida Petrillo", "Marcos Ant√¥nio Faria"],
            ["12/nov.", "Quarta", "Lu√≠s Eduardo Gauer", "Jo√£o V√≠tor Almeida das Virgens"],
            ["13/nov.", "Quinta", "Thaisa Ramos Freire", "Isabella Colombani"],
            ["14/nov.", "Sexta", "Pedro Henrique de Moraes Moreira", "Liane Venesia Da Silva"],
            ["15/nov.", "S√°bado", "Ana Laura de Oliveira Carvalho", "Jose Paulo Sonda Sampaio"],
            ["16/nov.", "Domingo", "Pedro Henrique de Moraes Moreira", "Rian Henrico Alves Ferreira"],
            ["17/nov.", "Segunda", "Thaisa Ramos Freire", "Lu√≠s Eduardo Gauer"],
            ["18/nov.", "Ter√ßa", "Daniella Martins de Oliveira", "Jose Paulo Sonda Sampaio"],
            ["19/nov.", "Quarta", "Marcos Ant√¥nio Faria", "Ana Laura de Oliveira Carvalho"],
            ["20/nov.", "Quinta", "Jo√£o V√≠tor Almeida das Virgens", "Liane Venesia Da Silva"],
            ["21/nov.", "Sexta", "Isabella Colombani", "Lucas Catarino Garcia"],
            ["22/nov.", "S√°bado", "Daniella Martins de Oliveira", "Thaisa Ramos Freire"],
            ["23/nov.", "Domingo", "Rian Henrico Alves Ferreira", "Pedro Henrique de Moraes Moreira"],
            ["24/nov.", "Segunda", "Daniella Martins de Oliveira", "Lucas Catarino Garcia"],
            ["25/nov.", "Ter√ßa", "Jo√£o V√≠tor Almeida das Virgens", "Jose Paulo Sonda Sampaio"],
            ["26/nov.", "Quarta", "Isabella Colombani", "Ana Laura de Oliveira Carvalho"],
            ["27/nov.", "Quinta", "Liane Venesia Da Silva", "B√°rbara Geovanna Farias Dami√£o"],
            ["28/nov.", "Sexta", "Rian Henrico Alves Ferreira", "Lucas Catarino Garcia"],
            ["29/nov.", "S√°bado", "Marilia Escrivani de Almeida Petrillo", "Marcos Ant√¥nio Faria"],
            ["30/nov.", "Domingo", "Lu√≠s Eduardo Gauer", "Pedro Henrique de Moraes Moreira"],
            ["01/dez.", "Segunda", "B√°rbara Geovanna Farias Dami√£o", "Jose Paulo Sonda Sampaio"],
            ["02/dez.", "Ter√ßa", "Pedro Henrique de Moraes Moreira", "Ana Laura de Oliveira Carvalho"],
            ["03/dez.", "Quarta", "Liane Venesia Da Silva", "Marilia Escrivani de Almeida Petrillo"],
            ["04/dez.", "Quinta", "Ana Laura de Oliveira Carvalho", "Pedro Henrique de Moraes Moreira"],
            ["05/dez.", "Sexta", "Lucas Catarino Garcia", "B√°rbara Geovanna Farias Dami√£o"],
            ["06/dez.", "S√°bado", "Marcos Ant√¥nio Faria", "Jo√£o V√≠tor Almeida das Virgens"],
            ["07/dez.", "Domingo", "Jose Paulo Sonda Sampaio", "Isabella Colombani"],
            ["08/dez.", "Segunda", "Daniella Martins de Oliveira", "B√°rbara Geovanna Farias Dami√£o"],
            ["09/dez.", "Ter√ßa", "Thaisa Ramos Freire", "Rian Henrico Alves Ferreira"],
            ["10/dez.", "Quarta", "Lu√≠s Eduardo Gauer", ""],
            ["11/dez.", "Quinta", "B√°rbara Geovanna Farias Dami√£o", ""],
            ["12/dez.", "Sexta", "Jose Paulo Sonda Sampaio", ""],
            ["13/dez.", "S√°bado", "Lucas Catarino Garcia", "Pedro Henrique de Moraes Moreira"],
            ["14/dez.", "Domingo", "Ana Laura de Oliveira Carvalho", "Marilia Escrivani de Almeida Petrillo"],
            ["15/dez.", "Segunda", "Pedro Henrique de Moraes Moreira", ""],
            ["16/dez.", "Ter√ßa", "B√°rbara Geovanna Farias Dami√£o", ""],
            ["17/dez.", "Quarta", "Ana Laura de Oliveira Carvalho", ""],
            ["18/dez.", "Quinta", "Marilia Escrivani de Almeida Petrillo", ""],
            ["19/dez.", "Sexta", "Lu√≠s Eduardo Gauer", ""],
            ["20/dez.", "S√°bado", "Lucas Catarino Garcia", "Ana Laura de Oliveira Carvalho"],
            ["21/dez.", "Domingo", "Marilia Escrivani de Almeida Petrillo", "B√°rbara Geovanna Farias Dami√£o"],
            ["22/dez.", "Segunda", "Lucas Catarino Garcia", ""],
            ["23/dez.", "Ter√ßa", "Jose Paulo Sonda Sampaio", ""],
            ["24/dez.", "Quarta", "Pedro Henrique de Moraes Moreira", ""],
            ["25/dez.", "Quinta", "Lu√≠s Eduardo Gauer", "Lucas Catarino Garcia"],
            ["26/dez.", "Sexta", "Marilia Escrivani de Almeida Petrillo", ""],
            ["27/dez.", "S√°bado", "Lu√≠s Eduardo Gauer", "B√°rbara Geovanna Farias Dami√£o"],
            ["28/dez.", "Domingo", "Jose Paulo Sonda Sampaio", "Ana Laura de Oliveira Carvalho"],
            ["29/dez.", "Segunda", "Lucas Catarino Garcia", ""],
            ["30/dez.", "Ter√ßa", "Lu√≠s Eduardo Gauer", ""],
            ["31/dez.", "Quarta", "Jose Paulo Sonda Sampaio", ""],
            ["01/jan.", "Quinta", "Ana Laura de Oliveira Carvalho", "Pedro Henrique de Moraes Moreira"],
            ["02/jan.", "Sexta", "B√°rbara Geovanna Farias Dami√£o", "Marilia Escrivani de Almeida Petrillo"],
            ["03/jan.", "S√°bado", "Lucas Catarino Garcia", "Lu√≠s Eduardo Gauer"],
            ["04/jan.", "Domingo", "Pedro Henrique de Moraes Moreira", "Jose Paulo Sonda Sampaio"],
            ["05/jan.", "Segunda", "Marilia Escrivani de Almeida Petrillo", ""],
            ["06/jan.", "Ter√ßa", "Pedro Henrique de Moraes Moreira", ""],
            ["07/jan.", "Quarta", "Lu√≠s Eduardo Gauer", ""],
            ["08/jan.", "Quinta", "Ana Laura de Oliveira Carvalho", ""],
            ["09/jan.", "Sexta", "B√°rbara Geovanna Farias Dami√£o", ""],
            ["10/jan.", "S√°bado", "Lu√≠s Eduardo Gauer", "Jose Paulo Sonda Sampaio"],
            ["11/jan.", "Domingo", "Ana Laura de Oliveira Carvalho", "Lucas Catarino Garcia"],
            ["12/jan.", "Segunda", "Jose Paulo Sonda Sampaio", ""],
            ["13/jan.", "Ter√ßa", "Marilia Escrivani de Almeida Petrillo", ""],
            ["14/jan.", "Quarta", "Lucas Catarino Garcia", ""],
            ["15/jan.", "Quinta", "B√°rbara Geovanna Farias Dami√£o", ""],
            ["16/jan.", "Sexta", "Lu√≠s Eduardo Gauer", "Pedro Henrique de Moraes Moreira"],
            ["17/jan.", "S√°bado", "Marilia Escrivani de Almeida Petrillo", ""],
            ["18/jan.", "Domingo", "B√°rbara Geovanna Farias Dami√£o", "Jose Paulo Sonda Sampaio"],
            ["19/jan.", "Segunda", "Pedro Henrique de Moraes Moreira", ""],
            ["20/jan.", "Ter√ßa", "Ana Laura de Oliveira Carvalho", ""],
            ["21/jan.", "Quarta", "Lu√≠s Eduardo Gauer", ""],
            ["22/jan.", "Quinta", "Marilia Escrivani de Almeida Petrillo", ""],
            ["23/jan.", "Sexta", "Lucas Catarino Garcia", "Ana Laura de Oliveira Carvalho"],
            ["24/jan.", "S√°bado", "Jose Paulo Sonda Sampaio", ""],
            ["25/jan.", "Domingo", "Pedro Henrique de Moraes Moreira", "Lucas Catarino Garcia"],
            ["26/jan.", "Segunda", "B√°rbara Geovanna Farias Dami√£o", ""],
            ["27/jan.", "Ter√ßa", "Ana Laura de Oliveira Carvalho", ""],
            ["28/jan.", "Quarta", "Jose Paulo Sonda Sampaio", ""],
            ["29/jan.", "Quinta", "Pedro Henrique de Moraes Moreira", ""],
            ["30/jan.", "Sexta", "Lu√≠s Eduardo Gauer", ""],
            ["31/jan.", "S√°bado", "Marilia Escrivani de Almeida Petrillo", "B√°rbara Geovanna Farias Dami√£o"],
            ["01/fev.", "Domingo", "Lucas Catarino Garcia", "Lu√≠s Eduardo Gauer"]
        ];

        let currentUser = null;
        let naoTrocarDates = {};
        let currentSolicitacaoId = null;
        let trocasAplicadas = {};

        // Carregar prefer√™ncias de n√£o trocar
        async function loadNaoTrocarPreferences() {
            try {
                const q = query(collection(db, 'naoTrocar'));
                const snapshot = await getDocs(q);
                naoTrocarDates = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!data.deleted) {
                        const key = `${data.pessoa}_${data.data}_${data.tipo}`;
                        naoTrocarDates[key] = true;
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar prefer√™ncias:', error);
            }
        }

        // Carregar trocas do hist√≥rico
        async function loadTrocas() {
            try {
                const q = query(collection(db, 'historico'));
                const snapshot = await getDocs(q);
                trocasAplicadas = {};
                snapshot.forEach(doc => {
                    const troca = doc.data();
                    // Extrair data e tipo de cada plant√£o
                    const match1 = troca.plantao1.match(/(.+?)\s+\((\w+)\)/);
                    const match2 = troca.plantao2.match(/(.+?)\s+\((\w+)\)/);
                    
                    if (match1 && match2) {
                        const key1 = `${match1[1]}_${match1[2]}`;
                        const key2 = `${match2[1]}_${match2[2]}`;
                        trocasAplicadas[key1] = { pessoa: troca.pessoa2, trocado: true, historicoId: doc.id };
                        trocasAplicadas[key2] = { pessoa: troca.pessoa1, trocado: true, historicoId: doc.id };
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar trocas:', error);
            }
        }

        // Verificar se uma data est√° marcada como n√£o trocar
        function isNaoTrocar(pessoa, data, tipo) {
            const key = `${pessoa}_${data}_${tipo}`;
            return naoTrocarDates[key] || false;
        }

        // Salvar prefer√™ncia de n√£o trocar
        async function toggleNaoTrocar(pessoa, data, tipo, checked) {
            const key = `${pessoa}_${data}_${tipo}`;
            try {
                if (checked) {
                    await setDoc(doc(db, 'naoTrocar', key), {
                        pessoa,
                        data,
                        tipo,
                        deleted: false
                    });
                    naoTrocarDates[key] = true;
                } else {
                    await setDoc(doc(db, 'naoTrocar', key), {
                        pessoa,
                        data,
                        tipo,
                        deleted: true
                    });
                    delete naoTrocarDates[key];
                }
            } catch (error) {
                console.error('Erro ao salvar prefer√™ncia:', error);
            }
        }

        // Carregar escala original
        function loadEscala() {
            const tbody = document.getElementById('escalaBody');
            tbody.innerHTML = '';
            
            escalaDataOriginal.forEach(row => {
                const tr = document.createElement('tr');
                const isFeriado = feriados.includes(row[0]);
                if (isFeriado) tr.classList.add('feriado');
                
                // Data
                const tdData = document.createElement('td');
                tdData.textContent = row[0];
                tr.appendChild(tdData);
                
                // Dia
                const tdDia = document.createElement('td');
                tdDia.textContent = row[1];
                tr.appendChild(tdDia);
                
                // Plant√£o Curto
                const tdCurto = document.createElement('td');
                tdCurto.textContent = row[2];
                tr.appendChild(tdCurto);
                
                // Checkbox N√£o Trocar (Curto)
                const tdCheckCurto = document.createElement('td');
                tdCheckCurto.className = 'checkbox-cell';
                if (row[2] === currentUser) {
                    const checkCurto = document.createElement('input');
                    checkCurto.type = 'checkbox';
                    checkCurto.checked = isNaoTrocar(currentUser, row[0], 'Curto');
                    checkCurto.onchange = function() {
                        toggleNaoTrocar(currentUser, row[0], 'Curto', this.checked);
                        if (this.checked) {
                            tr.classList.add('nao-trocar');
                            tr.classList.remove('feriado');
                        } else {
                            tr.classList.remove('nao-trocar');
                            if (isFeriado) tr.classList.add('feriado');
                        }
                    };
                    tdCheckCurto.appendChild(checkCurto);
                    if (checkCurto.checked) {
                        tr.classList.add('nao-trocar');
                        tr.classList.remove('feriado');
                    }
                } else {
                    tdCheckCurto.textContent = '-';
                }
                tr.appendChild(tdCheckCurto);
                
                // Plant√£o Longo
                const tdLongo = document.createElement('td');
                tdLongo.textContent = row[3] || '-';
                tr.appendChild(tdLongo);
                
                // Checkbox N√£o Trocar (Longo)
                const tdCheckLongo = document.createElement('td');
                tdCheckLongo.className = 'checkbox-cell';
                if (row[3] === currentUser) {
                    const checkLongo = document.createElement('input');
                    checkLongo.type = 'checkbox';
                    checkLongo.checked = isNaoTrocar(currentUser, row[0], 'Longo');
                    checkLongo.onchange = function() {
                        toggleNaoTrocar(currentUser, row[0], 'Longo', this.checked);
                        if (this.checked) {
                            tr.classList.add('nao-trocar');
                            tr.classList.remove('feriado');
                        } else {
                            tr.classList.remove('nao-trocar');
                            if (isFeriado) tr.classList.add('feriado');
                        }
                    };
                    tdCheckLongo.appendChild(checkLongo);
                    if (checkLongo.checked) {
                        tr.classList.add('nao-trocar');
                        tr.classList.remove('feriado');
                    }
                } else {
                    tdCheckLongo.textContent = '-';
                }
                tr.appendChild(tdCheckLongo);
                
                // Feriado
                const tdFeriado = document.createElement('td');
                tdFeriado.textContent = isFeriado ? 'Sim' : 'N√£o';
                tr.appendChild(tdFeriado);
                
                tbody.appendChild(tr);
            });
        }

        // Carregar escala atualizada com trocas
        function loadEscalaAtualizada() {
            const tbody = document.getElementById('escalaAtualizadaBody');
            tbody.innerHTML = '';
            
            escalaDataOriginal.forEach(row => {
                const tr = document.createElement('tr');
                const isFeriado = feriados.includes(row[0]);
                if (isFeriado) tr.classList.add('feriado');
                
                // Data
                const tdData = document.createElement('td');
                tdData.textContent = row[0];
                tr.appendChild(tdData);
                
                // Dia
                const tdDia = document.createElement('td');
                tdDia.textContent = row[1];
                tr.appendChild(tdDia);
                
                // Plant√£o Curto (com troca aplicada)
                const tdCurto = document.createElement('td');
                const keyCurto = `${row[0]}_Curto`;
                if (trocasAplicadas[keyCurto]) {
                    tdCurto.innerHTML = `${trocasAplicadas[keyCurto].pessoa} <span class="troca-badge">TROCADO</span>`;
                } else {
                    tdCurto.textContent = row[2];
                }
                tr.appendChild(tdCurto);
                
                // Plant√£o Longo (com troca aplicada)
                const tdLongo = document.createElement('td');
                const keyLongo = `${row[0]}_Longo`;
                if (trocasAplicadas[keyLongo]) {
                    tdLongo.innerHTML = `${trocasAplicadas[keyLongo].pessoa} <span class="troca-badge">TROCADO</span>`;
                } else {
                    tdLongo.textContent = row[3] || '-';
                }
                tr.appendChild(tdLongo);
                
                // Feriado
                const tdFeriado = document.createElement('td');
                tdFeriado.textContent = isFeriado ? 'Sim' : 'N√£o';
                tr.appendChild(tdFeriado);
                
                tbody.appendChild(tr);
            });
        }

        // Filtrar escala original
        window.filterEscala = function() {
            const filterName = document.getElementById('filterName').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value.toLowerCase();
            const tbody = document.getElementById('escalaBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const data = cells[0].textContent.toLowerCase();
                const curto = cells[2].textContent.toLowerCase();
                const longo = cells[4].textContent.toLowerCase();
                
                const matchDate = !filterDate || data.includes(filterDate);
                const matchName = !filterName || curto.includes(filterName) || longo.includes(filterName);
                
                row.style.display = (matchDate && matchName) ? '' : 'none';
            }
        };

        window.clearFilters = function() {
            document.getElementById('filterName').value = '';
            document.getElementById('filterDate').value = '';
            filterEscala();
        };

        // Filtrar escala atualizada
        window.filterEscalaAtualizada = function() {
            const filterName = document.getElementById('filterNameAtualizada').value.toLowerCase();
            const filterDate = document.getElementById('filterDateAtualizada').value.toLowerCase();
            const tbody = document.getElementById('escalaAtualizadaBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const data = cells[0].textContent.toLowerCase();
                const curto = cells[2].textContent.toLowerCase();
                const longo = cells[3].textContent.toLowerCase();
                
                const matchDate = !filterDate || data.includes(filterDate);
                const matchName = !filterName || curto.includes(filterName) || longo.includes(filterName);
                
                row.style.display = (matchDate && matchName) ? '' : 'none';
            }
        };

        window.clearFiltersAtualizada = function() {
            document.getElementById('filterNameAtualizada').value = '';
            document.getElementById('filterDateAtualizada').value = '';
            filterEscalaAtualizada();
        };

        // Carregar dropdowns
        function loadDropdowns() {
            const pessoas = new Set();
            const datas = [];
            
            escalaDataOriginal.forEach(row => {
                pessoas.add(row[2]);
                if (row[3]) pessoas.add(row[3]);
                datas.push(row[0] + ' - ' + row[1]);
            });
            
            // Filtro de nomes (escala original)
            const filterNameSelect = document.getElementById('filterName');
            filterNameSelect.innerHTML = '<option value="">Todos</option>';
            Array.from(pessoas).sort().forEach(pessoa => {
                const option = document.createElement('option');
                option.value = pessoa;
                option.textContent = pessoa;
                filterNameSelect.appendChild(option);
            });

            // Filtro de nomes (escala atualizada)
            const filterNameAtualizadaSelect = document.getElementById('filterNameAtualizada');
            filterNameAtualizadaSelect.innerHTML = '<option value="">Todos</option>';
            Array.from(pessoas).sort().forEach(pessoa => {
                const option = document.createElement('option');
                option.value = pessoa;
                option.textContent = pessoa;
                filterNameAtualizadaSelect.appendChild(option);
            });
            
            // Data desejada
            const dataDesejadaSelect = document.getElementById('dataDesejada');
            dataDesejadaSelect.innerHTML = '<option value="">Selecione...</option>';
            datas.forEach(data => {
                const opt = document.createElement('option');
                opt.value = data;
                opt.textContent = data;
                dataDesejadaSelect.appendChild(opt);
            });
        }

        // Atualizar op√ß√µes de tipo baseado na data selecionada
        window.updateTipoDesejadoOptions = function() {
            const dataDesejada = document.getElementById('dataDesejada').value;
            const tipoDesejadoSelect = document.getElementById('tipoDesejado');
            
            if (!dataDesejada) {
                tipoDesejadoSelect.innerHTML = '<option value="">Selecione...</option><option value="Curto">Plant√£o Curto</option><option value="Longo">Plant√£o Longo</option>';
                return;
            }

            const dataKey = dataDesejada.split(' - ')[0];
            const rowIndex = escalaDataOriginal.findIndex(row => row[0] === dataKey);
            const row = escalaDataOriginal[rowIndex];

            tipoDesejadoSelect.innerHTML = '<option value="">Selecione...</option>';
            
            if (row[2]) {
                tipoDesejadoSelect.innerHTML += '<option value="Curto">Plant√£o Curto</option>';
            }
            if (row[3]) {
                tipoDesejadoSelect.innerHTML += '<option value="Longo">Plant√£o Longo</option>';
            }
        };

        // Filtrar datas dispon√≠veis baseado no tipo selecionado
        window.filterAvailableDates = function() {
            const tipoDesejado = document.getElementById('tipoDesejado').value;
            loadUserAvailableDates(tipoDesejado);
        };

        // Carregar datas dispon√≠veis do usu√°rio (filtradas por tipo)
        function loadUserAvailableDates(tipoFiltro = null) {
            const container = document.getElementById('datasDisponiveis');
            container.innerHTML = '';
            
            if (!tipoFiltro) {
                container.innerHTML = '<p style="color: #6c757d; padding: 10px;">Selecione o tipo de plant√£o desejado primeiro</p>';
                return;
            }
            
            let hasOptions = false;
            escalaDataOriginal.forEach(row => {
                // Verificar se o usu√°rio est√° nesta data (curto ou longo) e se √© do tipo correto
                if (row[2] === currentUser && tipoFiltro === 'Curto') {
                    hasOptions = true;
                    const div = document.createElement('div');
                    div.className = 'date-checkbox';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = `${row[0]}_Curto`;
                    checkbox.id = `date_${row[0]}_Curto`;
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = `${row[0]} ${row[1]} - Plant√£o Curto`;
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    container.appendChild(div);
                }
                
                if (row[3] === currentUser && tipoFiltro === 'Longo') {
                    hasOptions = true;
                    const div = document.createElement('div');
                    div.className = 'date-checkbox';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = `${row[0]}_Longo`;
                    checkbox.id = `date_${row[0]}_Longo`;
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = `${row[0]} ${row[1]} - Plant√£o Longo`;
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    container.appendChild(div);
                }
            });

            if (!hasOptions) {
                container.innerHTML = '<p style="color: #6c757d; padding: 10px;">Voc√™ n√£o tem plant√µes deste tipo dispon√≠veis</p>';
            }
        }

        // Login
        window.login = async function() {
            const userName = document.getElementById('loginSelect').value;
            if (!userName) {
                alert('Por favor, selecione seu nome');
                return;
            }
            
            currentUser = userName;
            document.getElementById('currentUserName').textContent = userName;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            await loadNaoTrocarPreferences();
            await loadTrocas();
            loadDropdowns();
            loadEscala();
            loadEscalaAtualizada();
            loadUserAvailableDates();
            loadSolicitacoes();
            loadHistorico();
        };

        // Logout
        window.logout = function() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        };

        // Enviar solicita√ß√£o
        window.enviarSolicitacao = async function() {
            const dataDesejada = document.getElementById('dataDesejada').value;
            const tipoDesejado = document.getElementById('tipoDesejado').value;
            const observacoes = document.getElementById('observacoes').value;
            
            if (!dataDesejada || !tipoDesejado) {
                showAlert('Por favor, preencha o plant√£o desejado (data e tipo)', 'error');
                return;
            }

            // Coletar datas selecionadas
            const checkboxes = document.querySelectorAll('#datasDisponiveis input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showAlert('Por favor, selecione pelo menos uma data sua dispon√≠vel para oferecer', 'error');
                return;
            }

            const datasOferecidas = [];
            checkboxes.forEach(cb => {
                const [data, tipo] = cb.value.split('_');
                datasOferecidas.push({ data, tipo });
            });

            // Encontrar destinat√°rio
            const dataKey = dataDesejada.split(' - ')[0];
            const rowIndex = escalaDataOriginal.findIndex(row => row[0] === dataKey);
            const destinatario = tipoDesejado === 'Curto' ? escalaDataOriginal[rowIndex][2] : escalaDataOriginal[rowIndex][3];

            // Verificar se o destinat√°rio marcou como n√£o trocar
            if (isNaoTrocar(destinatario, dataKey, tipoDesejado)) {
                showAlert('‚ö†Ô∏è Esta pessoa marcou que N√ÉO quer trocar este plant√£o. Solicita√ß√£o n√£o pode ser enviada.', 'warning');
                return;
            }
            
            try {
                await addDoc(collection(db, 'solicitacoes'), {
                    solicitante: currentUser,
                    destinatario,
                    dataDesejada,
                    tipoDesejado,
                    datasOferecidas,
                    dataEscolhida: null,
                    observacoes,
                    status: 'Pendente',
                    dataEnvio: serverTimestamp()
                });
                
                showAlert('‚úÖ Solicita√ß√£o enviada com sucesso!', 'success');
                
                // Limpar formul√°rio
                document.getElementById('dataDesejada').value = '';
                document.getElementById('tipoDesejado').value = '';
                document.getElementById('observacoes').value = '';
                checkboxes.forEach(cb => cb.checked = false);
                loadUserAvailableDates();
                
            } catch (error) {
                console.error('Erro ao enviar solicita√ß√£o:', error);
                showAlert('Erro ao enviar solicita√ß√£o. Tente novamente.', 'error');
            }
        };

        // Carregar solicita√ß√µes
        function loadSolicitacoes() {
            // Solicita√ß√µes recebidas
            const qRecebidas = query(
                collection(db, 'solicitacoes'),
                where('destinatario', '==', currentUser),
                where('status', '==', 'Pendente')
            );
            
            onSnapshot(qRecebidas, (snapshot) => {
                const tbody = document.getElementById('solicitacoesRecebidasBody');
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma solicita√ß√£o pendente</td></tr>`;
                    return;
                }
                
                snapshot.forEach((docSnap) => {
                    const sol = docSnap.data();
                    const dataEnvio = sol.dataEnvio ? new Date(sol.dataEnvio.toDate()).toLocaleDateString('pt-BR') : '-';
                    const datasOferecidasText = sol.datasOferecidas.map(d => `${d.data} (${d.tipo})`).join(', ');
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${dataEnvio}</td>
                        <td>${sol.solicitante}</td>
                        <td>${sol.dataDesejada} (${sol.tipoDesejado})</td>
                        <td>${datasOferecidasText}</td>
                        <td><span class="status-badge status-pendente">Pendente</span></td>
                        <td>${sol.observacoes || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="openDateModal('${docSnap.id}', '${JSON.stringify(sol.datasOferecidas).replace(/"/g, '&quot;')}', '${sol.solicitante}', '${sol.dataDesejada}', '${sol.tipoDesejado}')">Aprovar</button>
                                <button class="btn btn-danger" onclick="recusarSolicitacao('${docSnap.id}')">Recusar</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });

            // Solicita√ß√µes enviadas
            const qEnviadas = query(
                collection(db, 'solicitacoes'),
                where('solicitante', '==', currentUser)
            );
            
            onSnapshot(qEnviadas, (snapshot) => {
                const tbody = document.getElementById('solicitacoesEnviadasBody');
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma solicita√ß√£o enviada</td></tr>`;
                    return;
                }
                
                snapshot.forEach((docSnap) => {
                    const sol = docSnap.data();
                    const dataEnvio = sol.dataEnvio ? new Date(sol.dataEnvio.toDate()).toLocaleDateString('pt-BR') : '-';
                    const datasOferecidasText = sol.datasOferecidas.map(d => `${d.data} (${d.tipo})`).join(', ');
                    const dataEscolhidaText = sol.dataEscolhida ? `${sol.dataEscolhida.data} (${sol.dataEscolhida.tipo})` : '-';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${dataEnvio}</td>
                        <td>${sol.destinatario}</td>
                        <td>${sol.dataDesejada} (${sol.tipoDesejado})</td>
                        <td>${datasOferecidasText}</td>
                        <td><span class="status-badge status-${sol.status.toLowerCase()}">${sol.status}</span></td>
                        <td>${dataEscolhidaText}</td>
                        <td>${sol.observacoes || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Modal de sele√ß√£o de data
        let currentSolicitacaoData = null;
        window.openDateModal = function(solicitacaoId, datasJson, solicitante, dataDesejada, tipoDesejado) {
            currentSolicitacaoId = solicitacaoId;
            currentSolicitacaoData = {
                solicitante,
                dataDesejada,
                tipoDesejado
            };
            const datas = JSON.parse(datasJson.replace(/&quot;/g, '"'));
            
            const container = document.getElementById('modalDatesContainer');
            container.innerHTML = '';
            
            datas.forEach((d, index) => {
                const div = document.createElement('div');
                div.className = 'date-checkbox';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'selectedDate';
                radio.value = index;
                radio.id = `modal_date_${index}`;
                radio.dataset.data = d.data;
                radio.dataset.tipo = d.tipo;
                const label = document.createElement('label');
                label.htmlFor = radio.id;
                label.textContent = `${d.data} - Plant√£o ${d.tipo}`;
                div.appendChild(radio);
                div.appendChild(label);
                container.appendChild(div);
            });
            
            document.getElementById('dateSelectModal').style.display = 'flex';
        };

        window.closeDateModal = function() {
            document.getElementById('dateSelectModal').style.display = 'none';
            currentSolicitacaoId = null;
            currentSolicitacaoData = null;
        };

        window.confirmDateSelection = async function() {
            const selected = document.querySelector('input[name="selectedDate"]:checked');
            if (!selected) {
                alert('Por favor, selecione uma data');
                return;
            }
            
            try {
                const solRef = doc(db, 'solicitacoes', currentSolicitacaoId);
                
                const dataEscolhida = {
                    data: selected.dataset.data,
                    tipo: selected.dataset.tipo
                };
                
                await updateDoc(solRef, {
                    status: 'Aprovada',
                    dataEscolhida,
                    dataAprovacao: serverTimestamp()
                });
                
                // Adicionar ao hist√≥rico
                await addDoc(collection(db, 'historico'), {
                    pessoa1: currentSolicitacaoData.solicitante,
                    plantao1: `${dataEscolhida.data} (${dataEscolhida.tipo})`,
                    pessoa1Original: currentSolicitacaoData.solicitante,
                    plantao1Data: dataEscolhida.data,
                    plantao1Tipo: dataEscolhida.tipo,
                    pessoa2: currentUser,
                    plantao2: `${currentSolicitacaoData.dataDesejada.split(' - ')[0]} (${currentSolicitacaoData.tipoDesejado})`,
                    pessoa2Original: currentUser,
                    plantao2Data: currentSolicitacaoData.dataDesejada.split(' - ')[0],
                    plantao2Tipo: currentSolicitacaoData.tipoDesejado,
                    dataAprovacao: serverTimestamp()
                });
                
                closeDateModal();
                showAlert('‚úÖ Solicita√ß√£o aprovada!', 'success');
                
                // Recarregar trocas e escala atualizada
                await loadTrocas();
                loadEscalaAtualizada();
            } catch (error) {
                console.error('Erro ao aprovar:', error);
                showAlert('Erro ao aprovar solicita√ß√£o', 'error');
            }
        };

        // Recusar solicita√ß√£o
        window.recusarSolicitacao = async function(docId) {
            try {
                const solRef = doc(db, 'solicitacoes', docId);
                await updateDoc(solRef, {
                    status: 'Recusada',
                    dataRecusa: serverTimestamp()
                });
                showAlert('Solicita√ß√£o recusada', 'success');
            } catch (error) {
                console.error('Erro ao recusar:', error);
                showAlert('Erro ao recusar solicita√ß√£o', 'error');
            }
        };

        // Carregar hist√≥rico
        function loadHistorico() {
            const q = query(collection(db, 'historico'), orderBy('dataAprovacao', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('historicoBody');
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma troca realizada ainda</td></tr>`;
                    return;
                }
                
                snapshot.forEach((docSnap) => {
                    const hist = docSnap.data();
                    const dataAprov = hist.dataAprovacao ? new Date(hist.dataAprovacao.toDate()).toLocaleDateString('pt-BR') : '-';
                    const tr = document.createElement('tr');
                    
                    // Verificar se o usu√°rio atual √© o dono original de alguma das vagas
                    const podeRevogar = (hist.pessoa1Original === currentUser) || (hist.pessoa2Original === currentUser);
                    
                    tr.innerHTML = `
                        <td>${hist.pessoa1}</td>
                        <td>${hist.plantao1}</td>
                        <td>${hist.pessoa2}</td>
                        <td>${hist.plantao2}</td>
                        <td>${dataAprov}</td>
                        <td>
                            ${podeRevogar ? `<button class="btn btn-warning" onclick="revogarTroca('${docSnap.id}')">Revogar</button>` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Revogar troca
        window.revogarTroca = async function(historicoId) {
            if (!confirm('Tem certeza que deseja revogar esta troca? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'historico', historicoId));
                showAlert('‚úÖ Troca revogada com sucesso!', 'success');
                
                // Recarregar trocas e escala atualizada
                await loadTrocas();
                loadEscalaAtualizada();
            } catch (error) {
                console.error('Erro ao revogar troca:', error);
                showAlert('Erro ao revogar troca', 'error');
            }
        };

        // Mostrar alerta
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Trocar aba
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        };
    </script>
</body>
</html>
